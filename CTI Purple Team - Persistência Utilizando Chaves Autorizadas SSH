
<p align="center">
  <img src="./imagens/ISHLOGO.png" alt="Logo do Purple Team" width="300" height="300">
</p>

# CTI Purple Team - Persistência Utilizando Chaves Autorizadas SSH

Nesta pesquisa, iremos abordar a tática [TA0003](https://attack.mitre.org/tactics/TA0003/) (Persistência), dando ênfase a sub-técnica [T1098.004](https://attack.mitre.org/techniques/T1098/004/) (Account Manipulation: SSH Authorized Keys).

A tática de persisência é uma das maneiras pelas quais os invasores podem explorar eventos específicos do sistema para executar código malicioso de forma persistente. Neste ataque em questão, os adversários podem mudar o `autorized_keys`, arquivo SSH no Linux para manter a persistência no host da vítima. 

Uma vez dentro do sistema, mesmo que a máquina seja reiniciada ou as chaves de acesso SSH sejam modificadas, isso pode incluir adição de entradas ao cronjob, instalação de backdoors, ou, especificamente para o nosso caso, adição de chaves SSH autorizadas.

**A priori, para executar o sequestro de extensão, é importante salientar que o atacante já possua o primeiro acesso inicial à máquina alvo, com privilégios administrativos. Portando, já ter realizado a Execução e Escalação de Privilégios na vítima**.

## Contexto

SSH ou Shell Seguro, é um protocolo de internet criptografado de código aberto usado para administrar e comunicar-se com servidores e executar comandos remotamente. Um servidor SSH pode autenticar clientes usando vários métodos diferentes. A mais básica delas é a autenticação por senha, que é fácil de usar, mas não é a mais segura.

A manipulação de contas refere-se à criação, modificação ou exclusão de contas de usuários ou outras credenciais na infraestrutura de TI de uma organização. Embora existem algumas maneiras diferentes de fazer login em um servidor SSH, neste guia nos concentraremos na configuração de chaves SSH.

O `autorized_keys` arquivo em SSH especifica as chaves SSH que podem ser usadas para fazer login na conta de usuário para a qual o arquivo está configurado.

O diretório `.ssh` dentro do diretório inicial do usuário contém esse arquivo,`<user-home>/.ssh/autorized_keys`. Por exemplo, para um usuário chamado smith, você pode encontrar o `autorized_keys` arquivo localizado em `/home/smith/.ssh/autorized_keys`. Este arquivo define as chaves públicas que este usuário usa para fazer login em algumas de suas contas. Cada linha do arquivo representa uma única chave pública.

Os usuários podem editar o arquivo de configuração SSH do sistema para modificar as diretivas `PubKeyAuthentication` e `RSAAuthentication` para o valor `"yes"` para garantir que a  chave pública e a autenticada RSA estejam habilitadas em `/etc/ssh/sshd-config`.

## Emulação de Ameaça - Etapa I: Criação da Chave SSH

Para começar a usar o SSH sem senha é preciso gerar um par de chaves SSH em seu computador local. Neste guia vamos focar na versão 2 do SSH, que é a mais recente e mais segura.

Primeiro, verificamos se a chave SSH para a máquina atacante já existe. Isto irá prevenir que a configuração atual seja sobrescrita, caso haja uma. Utilizaremos o comando abaixo:

```zsh
ls -al ~/.ssh/id_*.pub
``` 

Se houver uma chave existente, você tem as opções de pular os passos de geração de uma chave SSH, sobrescrever as configurações atuais ou criar um backup da chave existente. Se a chave não existir, você vai ver o seguinte resultado:

<p align="center">
  <img src="imagens/chave não existente.png">
  <br>
  Figura : Par de Chaves SSH Não Existente
</p>

Se a chave ja existir, terá um output como abaixo:

<p align="center">
  <img src="imagens/chaves existente.png">
  <br>
  Figura : Par de Chaves SSH Existentes
</p>

Em seguida, vamos prosseguir com a geração da chave SSH. Para gerar uma chave pública no Ubuntu, utiliza-se o utilitário especial chamado `ssh-keygen -t rsa` ou também pode utilizar a versão mais simples do comando `ssh-keygen`. 

***Info***: A opção *`-t`* significa *type* e *`RSA`* é o protocolo padrão utilizado na geração da chave.

```zsh
ssh-keygen -t rsa
```
```zsh
ssh-keygen
```

Você será solicitado para escolher um local para as chaves que serão geradas. Por padrão, as chaves serão armazenadas no diretório `~/.ssh` do diretório inicial do usuário. A chave privada será chamada `id_rsa` e a chave pública associada será chamada `id_rsa.pub`. 

Caso queira escolher outro local, basta digitá-lo agora, caso contrário, apenas pressione `ENTER` para aceitar o padrão.

<p align="center">
  <img src="imagens/local para chave.png">
  <br>
  Figura : Atribuindo Local para o Par de Chaves SSH
</p>

***Info:*** A chave padrão é de 2048 bits. Mas se você quer mais segurança basta trocar o valor para 4096 bits. Neste caso o comando será:

```zsh
ssh-keygen -t rsa -b 4096
```

Em seguida, será solicitado atribuir uma senha para a chave. Este é um processo opcional, tendo em consideração que essa senha pode ser usada para criptografar o arquivo de chave privada do disco.

<p align="center">
  <img src="imagens/senha para chave.png">
  <br>
  Figura : Atribuir senha para a Chave Criada
</p>

Abaixo podemos vizualizar o par de chaves criadas com sucesso:

<p align="center">
  <img src="imagens/par de chaves criada.png">
  <br>
  Figura : Atribuir senha para a Chave Criada
</p>

A próxima etapa é colocar a chave pública em seu servidor para que você possa usar a autenticação de chave SSH para fazer login.

## Emulação de Ameaça - Etapa II: Copiando uma Chave Pública SSH Para o seu Servidor

Existem várias maneiras de encaminhar sua chave pública para o servidor SSH remoto. A escolha do método a ser utilizado varia conforme as ferramentas à disposição e as especificidades da sua configuração atual. Sâo eles:

  - Utilizar o comando ssh-copy-id.
  - Copiar utilizando o SSH.
  - Copiar manualmente.

Embora os métodos abaixo alcancem o mesmo resultado final, o mais direto e automatizado é apresentado em primeiro lugar. As alternativas subsequentes demandam passos manuais adicionais, devendo ser adotadas somente se os métodos anteriores não forem viáveis.

### 1° Método: Copiar a Chave Pública usando o Comando `ssh-copy-id`

Uma forma direta de transferir sua chave pública para um servidor já existente é através do `ssh-copy-id`, um utilitário conhecido pela sua simplicidade. Se estiver disponível, é recomendado utilizá-lo.

O ssh-copy-id faz parte dos pacotes OpenSSH em muitas distribuições, o que significa que você provavelmente já o tem instalado no seu sistema local. No entanto, para que esse método funcione, é necessário ter acesso SSH com senha ao servidor.

Para usar o utilitário, você precisa especificar o host remoto ao qual deseja se conectar e a conta de usuário à qual você tem acesso SSH baseado em senha. Esta é a conta onde sua chave SSH pública será copiada.

A sintaxe do comanda é:

```zsh
ssh-copy-id username@remote_host
```
Você pode ver uma mensagem como esta:

<p align="center">
  <img src="imagens/">
  <br>
  Figura : 
</p>

Isso significa que o seu computador local não reconhece o host remoto. Isso acontecerá na primeira vez que você se conectar a um novo host. Digite `yes` e pressione `ENTER` para continuar.

Em seguida, o utilitário verificará sua conta local em busca da `id_rsa.pub`, chave que criamos anteriormente. Ao encontrar a chave, ele solicitará a senha da conta do usuário remoto:

<p align="center">
  <img src="imagens/auntenticação na chave.png">
  <br>
  Figura : Senha da Conta Remota
</p>

Digite a senha (sua digitação não será exibida por motivos de segurança) e pressione ENTER. O utilitário se conectará à conta no host remoto usando a senha fornecida. Em seguida, ele copiará o conteúdo da sua cahve `~/.ssh/id_rsa.pub` em um arquivo no `~/.ssh` diretório inicial da conta remota chamado ***`authorized_keys`***.

Você verá uma saída semelhante a esta:

<p align="center">
  <img src="imagens/">
  <br>
  Figura : 
</p>

Neste ponto, sua chave **`id_rsa.pub`** foi carregada na conta remota. Você pode continuar na próxima seção.

### 2° Método: Copiar a Chave Pública usando `SSH`

Se você não tiver ssh-copy-idacesso SSH baseado em senha a uma conta em seu servidor, poderá fazer upload de suas chaves usando um método SSH convencional.

Podemos fazer isso enviando o conteúdo de nossa chave SSH pública em nosso computador local e canalizando-o por meio de uma conexão SSH para o servidor remoto. Por outro lado, podemos ter certeza de que o ~/.sshdiretório existe na conta que estamos usando e então enviar o conteúdo que canalizamos para um arquivo chamado authorized_keysdentro deste diretório.

Usaremos o símbolo `>>` de redirecionamento para anexar o conteúdo em vez de substituí-lo. Isso nos permitirá adicionar chaves sem destruir as chaves adicionadas anteriormente.

O comando completo ficará assim:

```zsh
cat ~/.ssh/id_rsa.pub | ssh username@remote_host "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

Você pode ver uma mensagem como esta:

<p align="center">
  <img src="imagens/local da chave.png">
  <br>
  Figura : 
</p>

Isso significa que o seu computador local não reconhece o host remoto. Isso acontecerá na primeira vez que você se conectar a um novo host. Digite yese pressione ENTERpara continuar.

Posteriormente, você será solicitado a fornecer a senha da conta à qual está tentando se conectar:

<p align="center">
  <img src="imagens/local da chave.png">
  <br>
  Figura : 
</p>

Após inserir sua senha, o conteúdo da sua id_rsa.pubchave será copiado para o final do authorized_keysarquivo da conta do usuário remoto. Continue para a próxima seção se tiver sido bem-sucedido.

### 3° Método: Copiar a Chave Pública usando Manualmente

Se você não tiver acesso SSH baseado em senha ao seu servidor disponível, você terá que fazer o processo acima manualmente.

O conteúdo do seu id_rsa.pubarquivo deverá ser adicionado a um arquivo ~/.ssh/authorized_keysna sua máquina remota de alguma forma.

Para exibir o conteúdo da sua id_rsa.pubchave, digite isto em seu computador local:

```zsh
cat ~/.ssh/id_rsa.pub
```

Você verá o conteúdo da chave, que pode ser parecido com isto:

<p align="center">
  <img src="imagens/local da chave.png">
  <br>
  Figura : 
</p>

Acesse seu host remoto usando qualquer método disponível. Pode ser um console baseado na Web fornecido pelo seu provedor de infraestrutura.

Depois de ter acesso à sua conta no servidor remoto, você deve certificar-se de que o ~/.sshdiretório foi criado. Este comando criará o diretório se necessário ou não fará nada se ele já existir:

```zsh
mkdir -p ~/.ssh
```

Agora você pode criar ou modificar o authorized_keysarquivo neste diretório. Você pode adicionar o conteúdo do seu id_rsa.pubarquivo ao final do authorized_keysarquivo, criando-o se necessário, usando isto:

```zsh
echo public_key_string >> ~/.ssh/authorized_keys
```

No comando acima, substitua public_key_stringpela saída do cat ~/.ssh/id_rsa.pubcomando que você executou em seu sistema local. Deve começar com ssh-rsa AAAA...ou similar.

Se isso funcionar, você pode testar sua nova autenticação SSH baseada em chave.

## Emulação de Ameaça - Etapa III: Autenticando no Servidor usando Chaves SSH

Se você tiver concluído com êxito um dos procedimentos acima, deverá conseguir fazer login no host remoto sem a senha da conta remota.

O processo é basicamente o mesmo:

```zsh
ssh username@remote_host
```

Se esta for a primeira vez que você se conecta a este host (se você usou o último método acima), você poderá ver algo assim:

<p align="center">
  <img src="imagens/local da chave.png">
  <br>
  Figura : 
</p>

Isso significa que o seu computador local não reconhece o host remoto. Digite yese pressione ENTERpara continuar.

Se você não forneceu uma senha para sua chave privada, você fará login imediatamente. Se você forneceu uma senha para a chave privada quando criou a chave, será necessário inseri-la agora. Posteriormente, uma nova sessão shell será criada para você com a conta no sistema remoto.

Se tiver sucesso, continue para descobrir como bloquear o servidor.

## Emulação de Ameaça - Etapa IV: Desabilitar a Autenticação por Senha SSH

Se você conseguiu fazer login em sua conta usando SSH sem uma senha, você configurou com êxito a autenticação baseada em chave SSH em sua conta. No entanto, o seu mecanismo de autenticação baseado em senha ainda está ativo, o que significa que o seu servidor ainda está exposto a ataques de força bruta.

Antes de concluir as etapas desta seção, certifique-se de ter a autenticação baseada em chave SSH configurada para a conta raiz neste servidor ou, de preferência, de ter a autenticação baseada em chave SSH configurada para uma conta neste servidor com sudoacesso. Esta etapa bloqueará logins baseados em senha, portanto, é essencial garantir que você ainda poderá obter acesso administrativo.

Assim que as condições acima forem verdadeiras, faça login em seu servidor remoto com chaves SSH, como root ou com uma conta com sudoprivilégios. Abra o arquivo de configuração do daemon SSH:

```zsh
sudo nano /etc/ssh/sshd_config
```

Dentro do arquivo, procure por uma diretiva chamada PasswordAuthentication. Isso pode ser comentado. Remova o comentário da linha removendo qualquer #no início da linha e defina o valor como no. Isso desativará sua capacidade de fazer login por meio de SSH usando senhas de conta:

<p align="center">
  <img src="imagens/event ID 4657.png">
  <br>
  Figura 12: Ativação do Event ID 4657
</p>

Salve e feche o arquivo quando terminar. Para realmente implementar as alterações que acabamos de fazer, você deve reiniciar o serviço.

Na maioria das distribuições Linux, você pode emitir o seguinte comando para fazer isso:

```zsh
sudo systemctl restart ssh
```

Depois de concluir esta etapa, você fez a transição bem-sucedida do seu daemon SSH para responder apenas às chaves SSH.

## Engenharia de Detecção

A detecção consiste em ativar a auditoria de segurança do *Event ID 4657*, seguindo o fluxo demonstrado na imagem abaixo.

<p align="center">
  <img src="imagens/event ID 4657.png">
  <br>
  Figura 12: Ativação do Event ID 4657
</p>

Como podemos observar, o comportamento produzido pela modificação da chave de registro é bem notório, gerando um único evento encontrado no *Microsoft Security Event IDs* e um único Event do Sysmon:

- [4657: A Registry Value was Modified](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=4657)
- Log 13, Sysmon

<p align="center">
  <img src="imagens/Event ID log de alteração.png">
  <br>
  Figura 13: Log evidenciando a alteração da chave de registro
</p>

<p align="center">
  <img src="imagens/Event ID 13, Sysmom.png">
  <br>
  Figura 14: Event 13, Sysmon
</p>

### Padrão SIGMA: Event Triggered Execution: Change Default File Association

```yaml
title: 'CTI Purple Team - Persistência Utilizando Chaves Autorizadas SSH'
id: 19469c03-2a2e-4cce-953c-374a8d16c40d
status: stable
description: 'Esta regra detecta o comportamento gerado pela modificação da chave de registro de uma extenção de arquivo, para a realização de Persistência.'
references:
    - 'https://attack.mitre.org/techniques/T1098/004/'
author: CTI Purple Team
date: 10/04/2024
tags:
    - attack.persistence.TA0003
    - attack.T1098.004 # Account Manipulation: SSH Authorized Keys
logsource:
    category: 'process_creation'
    product: 'windows', 'sysmon'
detection:
    RegistryModification:
      EventID:
        - 4657
        - 13
      TargetRegistryKey|contains|all:
        - 'shell'
        - 'open'
        - 'command'
    condition: RegistryModification
fields:
    - ProcessName;
    - TargetObject.
falsepositives:
    - No
level: high
```

## Conclusão

Agora você deve ter a autenticação baseada em chave SSH configurada e em execução no seu servidor, permitindo entrar sem fornecer uma senha de conta. A partir daqui, há muitas direções que você pode seguir. Se quiser saber mais sobre como trabalhar com SSH, dê uma olhada em nosso guia básico de SSH .

Esperamos que você que leu ou assistiu o Webinar, possa ter compreendido a inteligência que trouxemos nesta pesquisa. Qualquer dúvida, é só nos contactar.

## Link do Webinar

Caso você não pode participar do Webinar de apresentação da pesquisa, ou gostaria rever, basta clicar neste [link](https://ishtecnologia.sharepoint.com/:v:/s/CTI-PurpleTeam/Ec4VyYNxFWtHlKHst_JMY5oBxP0OOPMKydRHO1BqWFiNpQ?e=D94s2B&nav=eyJyZWZlcnJhbEluZm8iOnsicmVmZXJyYWxBcHAiOiJTdHJlYW1XZWJBcHAiLCJyZWZlcnJhbFZpZXciOiJTaGFyZURpYWxvZy1MaW5rIiwicmVmZXJyYWxBcHBQbGF0Zm9ybSI6IldlYiIsInJlZmVycmFsTW9kZSI6InZpZXcifX0%3D).



